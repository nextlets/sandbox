# Node Basic Operations

- [Structure of Node](#structure-of-node)
- [Available Actions](#available-actions)
    - [Entity Set Actions](#entity-set-actions)
    - [Operation Actions](#operation-actions)
- [Api Spec](#api-spec)
    - [Java](#java)
    - [JS](#js)
- [Usage Sample](#usage-sample)
    - [Create new node](#create-new-node)
        - [Java](#java)
    - [E2E Spec link](#e2e-spec-link)
- [Api DSL](#api-dsl)
- [References](#references)

**Node** - the one of basic objects in **Regent**, all nodes are related to trees.
Nodes have hierarchy parent-child. In difference of classic trees when one node
has one parent and many children, **Regent** provides possibility to link node anywhere,
therefore one node in **Regent** can have many parents and many children.
Node contains tree identifier. However it does not mean that node cannot participate
in parent-child relations with nodes from different trees.

Each node has unique identifier in scope of one **Regent** instance.
Node is the OSA Entity, it means all basic operations available for OSA Entity Sets also available for Node.
Access to the Node is carried by ID.

Node has extentions:
* ``ReferenceNode`` - stored in Regent, contains info how to get node from external system (from GA for example);  
Reference Nodes are resolved automatically by Regent during access to them
* ``VirtualNode`` - node, received from external system, returned instead of ``ReferenceNode``
* ``ErrorNode`` - fake node, returned in case ``ReferenceNode` could not be resolved

# Structure of [Node](https://confluence.bw-sl.com/display/OSA/browse-0.2.2#browse-0.2.2-Node)
Persisted properties (fields):
* ``id`` - node identifier
* ``treeId`` - tree identifier
* ``metadata`` - list of key-value pairs, for example: ``'title' = 'My Node'``
* ``parents`` - list of parents
* ``children`` - list of children

Additional properties
* ``referenceNodes`` - list of reference nodes, generated by OSA by common rules, is not used directly

# Available Actions
## Entity Set Actions
* Add Node - creates new node
* Remove Node - removes node and all links to the node from other nodes (parents-children)
* Update Node - updates existing node
* Get Node - receives node by identifier
* Load parents - loads list of parents
* Load children - loads list of children
* Load tree - loads associated tree
* Set link to tree - set link to tree
* Add link to parents - adds link to parents
* Delete link to parents - removes link to parents
* Add link to children - adds link to children
* Delete link to children - removes link to children

## Operation Actions
* Get external node Ids - returns list of identifiers of all external nodes which are children for specified node;  
for example: tree contains N reference nodes, each reference node contains Id in external system; this operation returns
N external identifiers in case root node is passed as input parameter
* Update node tree -
* Remove subtree - removes subtree (all children) of a node
* Reset cache - resets the cache, cache is used for each particular user and contains resolved reference nodes

# Api Spec
## Java
`NodeEntitySet` API:
```java
public interface NodeEntitySet extends UpdatableEntitySet<Node> {
    void addLinkToChildren(String nodeId, java.util.List<String> childrenIds);
    void deleteLinkToChildren(String nodeId, java.util.List<String> childrenIds);
    void addLinkToParents(String nodeId, java.util.List<String> parentsIds);
    void deleteLinkToParents(String nodeId, java.util.List<String> parentsIds);
    void addLinkToReferenceNodes(String nodeId, java.util.List<String> referenceNodesIds);
    void deleteLinkToReferenceNodes(String nodeId, java.util.List<String> referenceNodesIds);
    void setLinkToTree(String nodeId, String treeId);
    java.util.List<Node> loadChildren(Node node);
    com.wolterskluwer.osa.commons.odata.EntityCollection<Node> loadChildren(Node node, com.wolterskluwer.osa.commons.odata.client.QueryBuilder queryBuilder);
    java.util.List<Node> loadParents(Node node);
    com.wolterskluwer.osa.commons.odata.EntityCollection<Node> loadParents(Node node, com.wolterskluwer.osa.commons.odata.client.QueryBuilder queryBuilder);
    java.util.List<ReferenceNode> loadReferenceNodes(Node node);
    com.wolterskluwer.osa.commons.odata.EntityCollection<ReferenceNode> loadReferenceNodes(Node node, com.wolterskluwer.osa.commons.odata.client.QueryBuilder queryBuilder);
    Tree loadTree(Node node);
    Tree loadTree(Node node, com.wolterskluwer.osa.commons.odata.client.QueryBuilder queryBuilder);
}
```
`Node Operations` API:
```java
public interface NodeOperationsOperationSet {
    public void removeSubtree(com.wolterskluwer.osa.browse.odata.api.RemoveSubtree request);
    public void removeSubtree(com.wolterskluwer.osa.browse.odata.api.RemoveSubtree request, ODataHttpMethod httpMethod);
    public void removeSubtree(com.wolterskluwer.osa.browse.odata.api.RemoveSubtree request, com.wolterskluwer.osa.commons.odata.client.QueryBuilder.Builder builder);
    public void removeSubtree(com.wolterskluwer.osa.browse.odata.api.RemoveSubtree request, com.wolterskluwer.osa.commons.odata.client.QueryBuilder.Builder builder, ODataHttpMethod httpMethod);
    public void updateNodeTree(com.wolterskluwer.osa.browse.odata.api.UpdateNodeTree request);
    public void updateNodeTree(com.wolterskluwer.osa.browse.odata.api.UpdateNodeTree request, ODataHttpMethod httpMethod);
    public void updateNodeTree(com.wolterskluwer.osa.browse.odata.api.UpdateNodeTree request, com.wolterskluwer.osa.commons.odata.client.QueryBuilder.Builder builder);
    public void updateNodeTree(com.wolterskluwer.osa.browse.odata.api.UpdateNodeTree request, com.wolterskluwer.osa.commons.odata.client.QueryBuilder.Builder builder, ODataHttpMethod httpMethod);
    public com.wolterskluwer.osa.commons.odata.EntityCollection<java.lang.String> getExternalNodesIds(com.wolterskluwer.osa.browse.odata.api.GetExternalNodesIds request);
    public com.wolterskluwer.osa.commons.odata.EntityCollection<java.lang.String> getExternalNodesIds(com.wolterskluwer.osa.browse.odata.api.GetExternalNodesIds request, ODataHttpMethod httpMethod);
    public com.wolterskluwer.osa.commons.odata.EntityCollection<java.lang.String> getExternalNodesIds(com.wolterskluwer.osa.browse.odata.api.GetExternalNodesIds request, com.wolterskluwer.osa.commons.odata.client.QueryBuilder.Builder builder);
    public com.wolterskluwer.osa.commons.odata.EntityCollection<java.lang.String> getExternalNodesIds(com.wolterskluwer.osa.browse.odata.api.GetExternalNodesIds request, com.wolterskluwer.osa.commons.odata.client.QueryBuilder.Builder builder, ODataHttpMethod httpMethod);
    public void resetCache(com.wolterskluwer.osa.browse.odata.api.ResetCache request);
    public void resetCache(com.wolterskluwer.osa.browse.odata.api.ResetCache request, ODataHttpMethod httpMethod);
    public void resetCache(com.wolterskluwer.osa.browse.odata.api.ResetCache request, com.wolterskluwer.osa.commons.odata.client.QueryBuilder.Builder builder);
    public void resetCache(com.wolterskluwer.osa.browse.odata.api.ResetCache request, com.wolterskluwer.osa.commons.odata.client.QueryBuilder.Builder builder, ODataHttpMethod httpMethod);
}
```

## JS
* [Node API](https://wolterskluwer.io/api/wk-osa-browse/0.2.2/classes/browse.node.html)
* [BrowseOsaService API](https://wolterskluwer.io/api/wk-osa-browse/0.2.2/classes/browse.browseosaservice.html)

# Usage Sample
## Create new node
See [Tree Basic Operations](./Tree Basic Operations) to know how to prepare project and create Tree.

### Java
```java
//
BrowseODataClient browseClient = getBrowseClient();
Tree tree = createTree(browseClient);

// Root node
Node rootNode = browseClient.getTreeEntitySet().loadRootNode(tree);

// Node title
KeyValuePair title = new KeyValuePair();
title.setKey("title");
title.setValue("I'm a child of root node");

// Create node
Node child = new Node();
child.setMetadata(Arrays.asList(title));
child.setTreeId(tree.getId());
child.setParents(Arrays.asList(rootNode));

// Add node
browseClient.getNodeEntitySet().add(child);

// Get children of root node and print them
List<Node> children = browseClient.getNodeEntitySet().loadChildren(rootNode);
children.forEach(x -> {
    System.out.println("Child node " + x.getId() + ": ");
    x.getMetadata().forEach(m -> {
        System.out.println("\t" + m.getKey() + " = " + m.getValue());
    });
});

```
Something like this is result:
```
Child node N3m:
	title = I'm a child of root node
```

## E2E Spec link
* [Node CRUD](https://stash.bw-sl.com/projects/REGENT/repos/regent-e2e-tests/browse/spec/regent/browse/node/crud.spec.js?raw)
* [Node Operations](https://stash.bw-sl.com/projects/REGENT/repos/regent-e2e-tests/browse/spec/regent/browse/node/operations.spec.js?raw)
* [Get Reference Node Ids](https://stash.bw-sl.com/projects/REGENT/repos/regent-e2e-tests/browse/spec/regent/browse/node/reference-get.spec.js?raw)

# Api DSL
* [Browse Domain DSL](https://stash.bw-sl.com/projects/OSA/repos/browse-domain/browse/models/browse.osadsl?raw)
* [browse-0.2.2](https://confluence.bw-sl.com/display/OSA/browse-0.2.2)

# References
* [Regent on Confluence](https://confluence.bw-sl.com/display/REGENT/REGENT)
